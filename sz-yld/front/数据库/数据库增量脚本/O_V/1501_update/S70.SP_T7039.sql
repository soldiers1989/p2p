DROP PROCEDURE IF EXISTS `S70`.`SP_T7039`;
DELIMITER ;;
CREATE DEFINER=`root`@`%` PROCEDURE `S70`.`SP_T7039`(IN _date DATE)
   
BEGIN 


	DECLARE	 _F01	 INT UNSIGNED	 DEFAULT	0;	

	DECLARE	 _F02	 INT UNSIGNED	 DEFAULT	0;	

	DECLARE	 _F03	 DECIMAL(20,2) DEFAULT 0.00;	

	DECLARE	 _F04	 DECIMAL(20,2) DEFAULT 0.00;	

	DECLARE	 _F05	 DECIMAL(20,2) DEFAULT 0.00;	

	DECLARE	 _F07	 INT UNSIGNED	 DEFAULT 0;	


	DECLARE	 _startDate	 DATE; 
	DECLARE	 _endDate	 DATE; 
	DECLARE	 _current_date	 DATE; 

	DECLARE _done INT UNSIGNED	 DEFAULT 0; 
	DECLARE _money_list CURSOR FOR SELECT F01 FROM S61.T6110 WHERE F10 = 'S'; 
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET _done = 1; 

	SET _current_date = IFNULL(_date,CURRENT_DATE()); 
	SET _current_date = DATE_SUB(_current_date,INTERVAL 1 DAY);
	SET _F01 = YEAR(_current_date); 
	SET _F02 = QUARTER(_current_date); 
	CALL SP_QUARTER_DATE(_F01,_F02,_startDate,_endDate); 

	OPEN _money_list; 

	REPEAT 
	FETCH _money_list INTO _F07; 

	IF NOT _done THEN 

	SELECT IFNULL(SUM(T6102.F06),0),IFNULL(SUM(T6102.F07),0) INTO _F03,_F04 FROM S61.T6102, S61.T6101 WHERE T6102.F02 = T6101.F01 
	AND T6101.F03 = 'FXBZJZH' AND T6102.F05>=_startDate AND DATE(T6102.F05)<= _endDate AND T6101.F02 = _F07; 

	SET _F05 = _F03 - _F04; 


	INSERT INTO S70.T7039 SET F01 = _F01, F02 = _F02,F03 = _F03, F04 = _F04,F05 = _F05 ,F07 = _F07 
	ON DUPLICATE KEY UPDATE F03 = VALUES(F03), F04 = VALUES(F04),F05 = VALUES(F05); 
	END IF; 
	UNTIL _done END REPEAT; 

	CLOSE _money_list; 

END
;;
DELIMITER ;