DROP PROCEDURE IF EXISTS `S70`.`SP_T7204`;
DELIMITER ;;
CREATE DEFINER=`root`@`%` PROCEDURE `S70`.`SP_T7204`()
BEGIN
	
	DECLARE _F01 INT DEFAULT 0;
	
	DECLARE _F02 INT DEFAULT 0;
	
	DECLARE _F03 INT DEFAULT 0; 

	DECLARE _F04 INT DEFAULT 0; 

	DECLARE _F05 VARCHAR(5); 

	DECLARE _F06 DECIMAL(20,2) DEFAULT 0.00; 

	DECLARE done INT DEFAULT 0; 

	DECLARE t_error INTEGER DEFAULT 0;  
	
	DECLARE CURSOR_JKLB CURSOR FOR
	SELECT	T6252.F03 AS ID,	DATE_FORMAT(T6252.F08, '%Y') AS YE,	DATE_FORMAT(T6252.F08, '%m') AS MO,
	T6252.F05 AS TEM,	T6252.F09 AS ST, IFNULL(SUM(T6252.F07), 0) AS SU 
	FROM	S62.T6252 WHERE T6252.F09  ='WH' GROUP BY ID, YE, MO, TEM, ST
	UNION ALL
	SELECT	T6252.F03 AS ID,	DATE_FORMAT(T6252.F10, '%Y') AS YE,	DATE_FORMAT(T6252.F10, '%m') AS MO,
		T6252.F05 AS TEM,	T6252.F09 AS ST,	IFNULL(SUM(T6252.F07), 0) AS SU 
	FROM	S62.T6252 WHERE T6252.F09  ='YH' GROUP BY ID, YE, MO, TEM, ST;

	
	DECLARE CURSOR_JKSXFLB CURSOR FOR
  SELECT T6101.F02,DATE_FORMAT(T6102.F05, '%Y') AS YE,	DATE_FORMAT(T6102.F05, '%m') AS MO,IFNULL(SUM(T6102.F07),0)
  FROM S61.T6102 ,S61.T6101 WHERE T6102.F02 = T6101.F01 AND T6102.F03=1201 AND T6101.F03 = 'WLZH'GROUP BY T6101.F02,YE,MO;

	
	DECLARE CURSOR_JKZH CURSOR FOR
	SELECT T6252.F03 AS ID, DATE_FORMAT(T6230.F24, '%Y') AS YE,	DATE_FORMAT(T6230.F24, '%m') AS MO, T6252.F05 AS TEM, 
	IFNULL(SUM(T6252.F07), 0) AS SU		FROM S62.T6252, S62.T6230
	WHERE T6252.F02 = T6230.F01		AND T6252.F05 IN (7001, 7002)		GROUP BY ID, YE, MO, TEM;

	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;  
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET t_error = 1;
	START TRANSACTION;
	
	DELETE FROM S70.T7204;
	
  OPEN CURSOR_JKLB;
	
	REPEAT
		FETCH CURSOR_JKLB INTO _F01,_F02,_F03,_F04,_F05,_F06;
		
		IF NOT done THEN
			IF _F04 = 7001 THEN
				IF _F05 = 'YH' THEN
					
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F06=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F06=_F06;
				ELSEIF _F05 = 'WH' THEN
					
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F10=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F10=_F06;
				END IF;

			ELSEIF _F04 = 7002 THEN
				IF _F05 = 'YH' THEN
					
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F07=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F07=_F06;
				ELSEIF _F05 = 'WH' THEN
				
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F11=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F11=_F06;
				END IF;

			ELSEIF _F04 = 7004 THEN
				IF _F05 = 'YH' THEN
					
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F08=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F08=_F06;
				ELSEIF _F05 = 'WH' THEN
					
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F12=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F12=_F06;
				END IF;
		
			ELSEIF _F04 = 7005 THEN
					
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F09=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F09=_F06;
			
			ELSEIF _F04 = 7007 THEN 
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F14=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F14=_F06;
			END IF;
			
		END IF;
	UNTIL done END REPEAT;
	
  CLOSE CURSOR_JKLB;  

	SET done = 0;
	
	
  OPEN CURSOR_JKSXFLB;
	
	REPEAT
		FETCH CURSOR_JKSXFLB INTO _F01,_F02,_F03,_F06;
			
			IF NOT done THEN
					
					INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F05=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F05=_F06;
			END IF;
		UNTIL done END REPEAT;
	
  CLOSE CURSOR_JKSXFLB;  

	SET done = 0;

	
  OPEN CURSOR_JKZH;
	
	REPEAT
		FETCH CURSOR_JKZH INTO _F01,_F02,_F03,_F04,_F06;
			
			IF NOT done THEN
				IF _F04 = 7001 THEN
						
						INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F03=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F03=_F06;

				ELSEIF _F04 = 7002 THEN
						
						INSERT INTO S70.T7204 SET F01=_F02,F02=_F03,F04=_F06,F13=_F01 ON DUPLICATE KEY UPDATE F04=_F06;
				END IF;
			END IF;
		UNTIL done END REPEAT;
	
  CLOSE CURSOR_JKZH;  
  
  IF t_error = 1 THEN 
		ROLLBACK;
	ELSE 
		COMMIT;
	END IF;
END
;;
DELIMITER ;