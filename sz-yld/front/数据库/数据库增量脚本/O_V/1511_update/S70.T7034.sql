/*
SQLyog Ultimate v8.32 
MySQL - 5.5.14-log : Database - S70
*********************************************************************
*/

/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
CREATE DATABASE /*!32312 IF NOT EXISTS*/`S70` /*!40100 DEFAULT CHARACTER SET utf8 */;

USE `S70`;

/* Procedure structure for procedure `SP_T7034` */

/*!50003 DROP PROCEDURE IF EXISTS  `SP_T7034` */;

DELIMITER $$

/*!50003 CREATE DEFINER=`root`@`%` PROCEDURE `SP_T7034`(IN _date DATE)
    COMMENT '平台用户数据统计-按季度'
BEGIN
	-- 平台用户数据统计-按季度			
	-- 年份
	DECLARE		_F01							INT 					UNSIGNED		DEFAULT	0;	
	-- 季度
	DECLARE		_F02							INT 					UNSIGNED		DEFAULT	0;	
	-- 用户数
	DECLARE		_F03							INT 					UNSIGNED		DEFAULT 0;	
	-- 新增用户数
	DECLARE		_F04							INT 					UNSIGNED		DEFAULT 0;	
	-- 借款用户数
	DECLARE		_F05							INT 					UNSIGNED		DEFAULT 0;	
	-- 投资用户数
	DECLARE		_F06							INT 					UNSIGNED		DEFAULT 0;	
	-- 新增借款人
	DECLARE		_F08							INT 					UNSIGNED		DEFAULT 0;	
	-- 新增投资人
	DECLARE		_F09							INT 					UNSIGNED		DEFAULT 0;	
						
	DECLARE		_startDate			DATE;
	DECLARE		_endDate				DATE;
	DECLARE		_current_date				DATE;
	SET _current_date = IFNULL(_date,CURRENT_DATE());
	SET _current_date = DATE_SUB(_current_date,INTERVAL 1 DAY);
	SET _F01 = YEAR(_current_date);
	SET _F02 = QUARTER(_current_date);
	CALL SP_QUARTER_DATE(_F01,_F02,_startDate,_endDate);
	SELECT COUNT(*) INTO _F03	 FROM S61.T6110 WHERE F01 <> (SELECT T7101.F01 FROM S71.T7101) AND F09 >= _startDate AND DATE(F09) <= _endDate;
	SELECT COUNT(*) INTO _F04	 FROM S61.T6110 WHERE F01 <> (SELECT T7101.F01 FROM S71.T7101) AND F09 >= _startDate AND DATE(F09) <= _endDate;
	SELECT COUNT(*) INTO _F05	 FROM S61.T6110 WHERE F01 <> (SELECT T7101.F01 FROM S71.T7101) AND F06 = 'FZRR' AND F10 = 'F' and F09 >= _startDate AND DATE(F09) <= _endDate;
	SELECT COUNT(*) INTO _F06	 FROM S61.T6110 WHERE F01 <> (SELECT T7101.F01 FROM S71.T7101) AND F06 = 'ZRR' AND F10 = 'F' and F09 >= _startDate AND DATE(F09) <= _endDate;
	SELECT COUNT(*) INTO _F08	 FROM S61.T6110 WHERE F01 <> (SELECT T7101.F01 FROM S71.T7101) AND F06 = 'FZRR' AND F10 = 'F' AND F09 >= _startDate AND DATE(F09) <= _endDate;
	SELECT COUNT(*) INTO _F09	 FROM S61.T6110 WHERE F01 <> (SELECT T7101.F01 FROM S71.T7101) AND F06 = 'ZRR' AND F10 = 'F' AND F09 >= _startDate AND DATE(F09) <= _endDate;
	INSERT INTO S70.T7034 SET F01 = _F01, F02 = _F02, F03 = _F03, F04 = _F04, F05 = _F05, F06 = _F06 , F08 = _F08, F09 = _F09 
	ON DUPLICATE KEY UPDATE F03 = VALUES(F03) , F04 = VALUES(F04),F05 = VALUES(F05),F06 = VALUES(F06),F08 = VALUES(F08),F09 = VALUES(F09);
END */$$
DELIMITER ;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
