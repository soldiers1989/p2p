DROP PROCEDURE IF EXISTS `S70`.`SP_T7040`;
DELIMITER ;;
CREATE DEFINER=`root`@`%` PROCEDURE `S70`.`SP_T7040`(IN _date DATE)
   
BEGIN
	
	
	DECLARE		_F01							INT 					UNSIGNED		DEFAULT	0;	
	
	DECLARE		_F03							DECIMAL(20,2) DEFAULT 0.00;	
	
	DECLARE		_F04							DECIMAL(20,2) DEFAULT 0.00;	
	
	DECLARE		_F05							DECIMAL(20,2) DEFAULT 0.00;	
	
	DECLARE		_F06							DECIMAL(20,2) DEFAULT 0.00;	
	
	DECLARE		_F07							DECIMAL(20,2) DEFAULT 0.00;	
	
	DECLARE		_F08						INT 					UNSIGNED		DEFAULT 0;	
	

	DECLARE		_startDate			DATE;
	DECLARE		_endDate				DATE;
	DECLARE		_current_date		DATE;
	
	DECLARE 	_done 					INT 					UNSIGNED		DEFAULT 0;
	DECLARE 	_money_list 			CURSOR FOR 		SELECT F01 FROM S70.T7029;
	DECLARE 	CONTINUE 				HANDLER FOR NOT FOUND SET _done = 1;

	SET _current_date = IFNULL(_date,CURRENT_DATE());
	SET _current_date = DATE_SUB(_current_date,INTERVAL 1 DAY);
	SET _F01 = YEAR(_current_date);
	CALL SP_YEAR_DATE(_F01,_startDate,_endDate);

	
	SET _F08 = 0 ;
	SELECT IFNULL(SUM(F04),0) INTO _F03 FROM S70.T7028 WHERE F06 = 'DF' AND F02>=_startDate AND DATE(F02)<= _endDate;
	SELECT IFNULL(SUM(F03),0) INTO _F04 FROM S70.T7028 WHERE F06 = 'DFHF' AND F02>=_startDate AND DATE(F02)<= _endDate;
	SELECT IFNULL(SUM(F03),0) INTO _F05 FROM S70.T7028 WHERE F06 = 'JKCJFWF' AND F02>=_startDate AND DATE(F02)<= _endDate;
	SELECT IFNULL(SUM(F03),0) INTO _F06 FROM S70.T7028 WHERE F06 = 'SDZJBZJ' AND F02>=_startDate AND DATE(F02)<= _endDate;
	SELECT IFNULL(SUM(F04),0) INTO _F07 FROM S70.T7028 WHERE F06 = 'SDKCBZJ' AND F02>=_startDate AND DATE(F02)<= _endDate;

	
	INSERT INTO S70.T7040 SET F01 = _F01, F03 = _F03, F04 = _F04,F05 = _F05,F06 = _F06 ,F07 = _F07 ,F08 = _F08
	ON DUPLICATE KEY UPDATE F03 = VALUES(F03), F04 = VALUES(F04),F05 = VALUES(F05),F06 = VALUES(F06), F07 = VALUES(F07),F08 = VALUES(F08);

	OPEN _money_list;
	
	REPEAT 
		FETCH _money_list INTO _F08;
			
		IF NOT _done THEN
				SELECT IFNULL(SUM(F05),0) INTO _F03 FROM S70.T7030 WHERE F02 = _F08 AND F07 = 'DF' AND F03>=_startDate AND F03<= _endDate;
				SELECT IFNULL(SUM(F04),0) INTO _F04 FROM S70.T7030 WHERE F02 = _F08 AND F07 = 'DFHF' AND F03>=_startDate AND F03<= _endDate;
				SELECT IFNULL(SUM(F04),0) INTO _F05 FROM S70.T7030 WHERE F02 = _F08 AND F07 = 'JKCJFWF' AND F03>=_startDate AND F03<= _endDate;
				SELECT IFNULL(SUM(F04),0) INTO _F06 FROM S70.T7030 WHERE F02 = _F08 AND F07 = 'SDZJBZJ' AND F03>=_startDate AND F03<= _endDate;
				SELECT IFNULL(SUM(F05),0) INTO _F07 FROM S70.T7030 WHERE F02 = _F08 AND F07 = 'SDKCBZJ' AND F03>=_startDate AND F03<= _endDate;
				SELECT _F03,_F04,_F05,_F06,_F07;
				
				INSERT INTO S70.T7040 SET F01 = _F01, F03 = _F03, F04 = _F04,F05 = _F05,F06 = _F06 ,F07 = _F07 ,F08 = _F08
				ON DUPLICATE KEY UPDATE F03 = VALUES(F03), F04 = VALUES(F04),F05 = VALUES(F05),F06 = VALUES(F06), F07 = VALUES(F07),F08 = VALUES(F08);

		END IF;
		UNTIL _done END REPEAT;

	CLOSE _money_list;

END
;;
DELIMITER ;
